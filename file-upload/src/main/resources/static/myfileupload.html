<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>XMLHttpRequest 文件上传</title>
</head>
<body>
<progress id="progressBar" value="0" max="100" style="width: 300px;"></progress>
<span id="percentage"></span><span id="time"></span>
<br/>
<input type="file" id="file" name="myFile"/>
<input type="button" onclick="UploadFile()" value="上传"/>
<input type="button" onclick="cancelUploadFile()" value="取消"/>
</body>
<script type="text/javascript">
    var xhr, ot, oloaded;

    // 上传文件的方法
    function UploadFile() {
        // 原生 js 获取文件对象
        var fileObj = document.getElementById("file").files[0];
        // 接收文件的后台地址
        var url = "http://192.168.20.150:8001/my/video/upload";
        // formdata 对象
        var form = new FormData();
        // 文件对象
        form.append("file", fileObj);

        // XMLHttpRequest 对象
        xhr = new XMLHttpRequest();
        // post 方式，url 服务器请求地址，true 开启异步处理
        xhr.open("post", url, true);

        // 请求完成
        xhr.onload = uploadComplete;
        // 请求失败
        xhr.onerror = uploadFailed;

        // 上传进度
        xhr.upload.onprogress = progressFunction;
        xhr.upload.onloadstart = function () {
            ot = new Date().getTime();
            oloaded = 0;
        };

        Base.os.android

        xhr.send(form);
    }

    // 上传成功响应
    function uploadComplete(result) {
        var data = JSON.parse(result.target.responseText);
        if (data.success) {
            alert("上传成功");
        } else {
            alert("上传失败");
        }
    }

    // 上传失败
    function uploadFailed(result) {
        console.log(result);
        alert("上传失败");
    }

    // 取消上传
    function cancelUploadFile() {
        xhr.abort();
    }

    // 上传进度
    function progressFunction(event) {
        var progressBar = document.getElementById("progressBar");
        var percentageDiv = document.getElementById("percentage");

        // event.total 传输的总字节，event.loaded 已经传输的字节
        // 如果 event.lengthComputable 不为真，则 event.total = 0
        if (event.lengthComputable) {
            progressBar.max = event.total;
            progressBar.value = event.loaded;
            percentageDiv.innerHTML = Math.round(event.loaded / event.total * 100) + "%";
        }

        var time = document.getElementById("time");
        // 获取当前时间
        var nt = new Date().getTime();
        var pertime = (nt - ot) / 1000;
        ot = new Date().getTime();
        var perload = event.loaded = oloaded;
        oloaded = event.loaded;

        // 计算上传速度(b/s)
        var speed = perload / pertime;
        var bspeed = speed;
        var units = 'b/s';
        if (speed / 1024 > 1) {
            speed = speed / 1024;
            units = 'k/s';
        }
        if (speed / 1024 > 1) {
            speed = speed / 1024;
            units = 'M/s';
        }
        speed = speed.toFixed(1);
        // 剩余时间
        var resttime = ((event.total - event.loaded) / bspeed).toFixed(1);
        time.innerHTML = '，速度：' + speed + units + '，剩余时间：' + resttime + 's';
        if (bspeed === 0) {
            time.innerHTML = '上传已取消';
        }
    }
</script>
</html>